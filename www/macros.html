<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:py="http://genshi.edgewall.org/" py:strip="">
    <?python
        from datetime import datetime, date
        import re
    ?>

    <py:def function="event_listing(events)">
        <table class="table table-bordered table-striped" py:with="show_weeks = len([e for e in events if e['week']])">
            <thead>
                <tr>
                    <th py:if="show_weeks">Week</th>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Dates</th>
                </tr>
            </thead>
            <tbody>
                <tr py:for="event in events">
                    <td py:if="show_weeks">${event['week']}</td>
                    <td>
                        <py:if test="event['start_date'] and datetime.strptime(event['start_date'], '%Y-%m-%d').date() &lt;= date.today() and event['end_date'] and date.today() &lt;= datetime.strptime(event['end_date'], '%Y-%m-%d').date()">
                            <span class="fa fa-hourglass-half" title="Happening Now"></span>&nbsp;
                        </py:if>
                        <py:choose test="event['event_type']">
                            <py:when test="2"><span class="fa fa-paper-plane" title="District Championship"></span>&nbsp;</py:when>
                            <py:when test="3"><span class="fa fa-globe" title="Championship Division"></span>&nbsp;</py:when>
                            <py:when test="4"><span class="fa fa-trophy" title="Championship Finals"></span>&nbsp;</py:when>
                        </py:choose>
                        <a href="/event/${event['key']}">${event['name']}</a>
                    </td>
                    <td>
                        <span class="${flag_icon_css(event['location'])}"></span>
                        <a href="https://www.google.com/maps/search/${event['venue_address'] or event['location']}" target="_blank">${event['location']}</a>
                    </td>
                    <td>
                        <py:choose>
                            <py:when test="event['end_date'] != event['start_date']">
                                ${datetime.strptime(event['start_date'], '%Y-%m-%d').strftime('%b %d').replace(' 0', ' ')}
                                -
                                ${datetime.strptime(event['end_date'], '%Y-%m-%d').strftime('%b %d, %Y').replace(' 0', ' ')}
                            </py:when>
                            <py:otherwise>
                                ${datetime.strptime(event['start_date'], '%Y-%m-%d').strftime('%b %d, %Y').replace(' 0', ' ') if event['start_date'] else ''}
                            </py:otherwise>
                        </py:choose>
                    </td>
                </tr>
            </tbody>
        </table>
    </py:def>

    <py:def function="event_info(event, team={})">
        <h2>
            <py:if test="event['start_date'] and datetime.strptime(event['start_date'], '%Y-%m-%d').date() &lt;= date.today() and event['end_date'] and date.today() &lt;= datetime.strptime(event['end_date'], '%Y-%m-%d').date()">
                <span class="fa fa-hourglass-half" title="Happening Now"></span>&nbsp;
            </py:if>
            <a href="/event/${event['key']}">${event['year']} ${event['name']}</a>
            <span class="badge" py:if="'teams' in event">${len(event['teams'])} teams</span>
        </h2>
        <h5>
            <span class="fa fa-calendar"></span>&nbsp;
            <py:if test="event['week'] or event['week'] == 0">Week ${event['week']} &mdash;</py:if>
            <py:choose>
                <py:when test="event['end_date'] != event['start_date']">
                    ${datetime.strptime(event['start_date'], '%Y-%m-%d').strftime('%b %d').replace(' 0', ' ')}
                    -
                    ${datetime.strptime(event['end_date'], '%Y-%m-%d').strftime('%b %d, %Y').replace(' 0', ' ')}
                </py:when>
                <py:otherwise>
                    ${datetime.strptime(event['start_date'], '%Y-%m-%d').strftime('%b %d, %Y').replace(' 0', ' ') if event['start_date'] else ''}
                </py:otherwise>
            </py:choose>
        </h5>
        <h5>
            <span class="fa fa-map-marker"></span>&nbsp;
            <span class="${flag_icon_css(event['location'])}"></span>
            <a href="https://www.google.com/maps/search/${event['venue_address'] or event['location']}" target="_blank">${event['venue_address'] or event['location']}</a>
        </h5>
        <h5 py:if="event['website']"><span class="fa fa-globe"></span>&nbsp;&nbsp;<a href="${event['website']}" target="_blank">${event['website']}</a></h5>
        <h5><span class="fa fa-lightbulb-o fa-rotate-180"></span>&nbsp;&nbsp;<a href="https://www.thebluealliance.com/event/${event['key']}" target="_blank">The Blue Alliance</a></h5>
        <h5 py:if="event['facebook_eid']"><span class="fa fa-facebook-official"></span>&nbsp;&nbsp;<a href="https://www.facebook.com/events/${event['facebook_eid']}" target="_blank">Facebook</a></h5>
        <h5 py:for="webcast in event['webcast']" py:if="'webcast' in event">${video_icon(webcast, 'both', 'title')}</h5>
        <py:if test="team">
            <py:if test="'rankings' in event and str(team['team_number']) in event['rankings']" py:with="ranking = event['rankings'][str(team['team_number'])]">
                <br class="hide-following hide-last" />
                <h5>
                    <span class="fa fa-sort-numeric-asc"></span>&nbsp;
                    <b>Rank ${ranking['rank']} / ${len(event['rankings'])}</b>
                    <py:if test="'wins' in ranking and 'losses' in ranking and 'ties' in ranking">with a record of <b>${int(ranking['wins'])}-${int(ranking['losses'])}-${int(ranking['ties'])}</b></py:if>
                    after <b>${ranking['played']} matches</b>
                </h5>
            </py:if>
            <py:if test="'stats' in event and event['stats']">
                <br class="hide-next hide-following hide-last" />
                <h5 py:if="'oprs' in event['stats'] and str(team['team_number']) in event['stats']['oprs']">
                    <span class="fa fa-crosshairs"></span>&nbsp;&nbsp;Offensive Power Rating:
                    <b>
                        Rank
                        ${sorted(event['stats']['oprs'], key=event['stats']['oprs'].get)[::-1].index(str(team['team_number'])) + 1}
                        / ${len(event['stats']['oprs'])}
                    </b>
                </h5>
                <h5 py:if="'dprs' in event['stats'] and str(team['team_number']) in event['stats']['dprs']">
                    <span class="fa fa-shield"></span>&nbsp;&nbsp;Defensive Power Rating:
                    <b>
                        Rank
                        ${sorted(event['stats']['dprs'], key=event['stats']['dprs'].get)[::-1].index(str(team['team_number'])) + 1}
                        / ${len(event['stats']['dprs'])}
                    </b>
                </h5>
                <h5 py:if="'ccwms' in event['stats'] and str(team['team_number']) in event['stats']['ccwms']">
                    <span class="fa fa-thumbs-o-up"></span>&nbsp;&nbsp;Calculated Contribution to Winning Margin:
                    <b>
                        Rank
                        ${sorted(event['stats']['ccwms'], key=event['stats']['ccwms'].get)[::-1].index(str(team['team_number'])) + 1}
                        / ${len(event['stats']['ccwms'])}
                    </b>
                </h5>
            </py:if>
            <py:if test="'awards' in event and event['awards'] and int(team['team_number']) in [int(r[0]['team_number'] or 0) for r in [a['recipient_list'] for a in event['awards']]]">
                <br class="hide-next" />
                <py:for each="award in event['awards']">
                    <py:for each="recipient in award['recipient_list']">
                        <py:with vars="team_number_normalized = re.sub(r'[^0-9]', '', str(recipient['team_number']))">
                            <h5 py:if="int(team_number_normalized or 0) == int(team['team_number'])">
                                <span class="fa fa-trophy"></span>
                                <span class="fa fa-bookmark" title="Blue Banner" py:if="award['award_type'] in [0,1,3] and event['event_type'] in [0,1,2,3,4]"></span>
                                &nbsp;${award['name']}
                                <py:if test="recipient['awardee']">&mdash; ${recipient['awardee']}</py:if>
                            </h5>
                        </py:with>
                    </py:for>
                </py:for>
            </py:if>
        </py:if>
    </py:def>


    <py:def function="match_name(match)">
        <py:choose test="match['comp_level']">
            <py:when test="'qm'">Quals</py:when>
            <py:when test="'ef'">Eighths</py:when>
            <py:when test="'qf'">Quarters</py:when>
            <py:when test="'sf'">Semis</py:when>
            <py:when test="'f'">Finals</py:when>
            <py:otherwise>${match['comp_level'].upper()}</py:otherwise>
        </py:choose>
        <py:if test="match['comp_level'] != 'qm'">${match['set_number']} Match</py:if>
        ${match['match_number']}
    </py:def>

    <py:def function="match_listing(matches)">
        <table class="table table-bordered table-striped text-center match-listing">
            <?python
                # Find all alliances
                alliances = []
                for match in matches:
                    for alliance in match['alliances']:
                        if alliance not in alliances:
                            alliances.append(alliance)
                alliances = sorted(alliances)
                # Find max team count per alliance
                alliances_teams = {}
                for alliance in alliances:
                    alliances_teams[alliance] = max([len(m['alliances'][alliance]['teams']) for m in matches]) or 1
                # Find max score
                max_score = max(max([max([m['alliances'][a]['score'] for a in m['alliances']]) for m in matches]), 0)
                # Find event winners (inferred)
                winners = []
                match_last = matches[::-1][0]
                if match_last['comp_level'] == 'f':
                    match_last_max_score = max([match_last['alliances'][a]['score'] for a in match_last['alliances']])
                    if match_last_max_score:
                        winners = [match_last['alliances'][a]['teams'] for a in match_last['alliances'] if match_last['alliances'][a]['score'] == match_last_max_score][0]
            ?>
            <thead>
                <tr class="visible-md visible-lg">
                    <th>Match</th>
                    <th py:if="[m for m in matches if 'time' in m and m['time']]">Time</th>
                    <th colspan="${alliances_teams[alliance]}" py:for="alliance in alliances">${alliance.title()} Alliance</th>
                    <th colspan="${len(alliances) or 1}" py:if="max_score">Scores</th>
                </tr>
                <tr class="hidden-md hidden-lg" py:for="alliance in alliances">
                    <th py:if="alliance == alliances[0]">Match</th>
                    <th rowspan="${len(alliances)-1}" py:if="alliance == alliances[1]">Time</th>
                    <th colspan="${alliances_teams[alliance]}">${alliance.title()} Alliance</th>
                    <th rowspan="${len(alliances)}" py:if="max_score and alliance == alliances[0]">Scores</th>
                </tr>
            </thead>
            <tbody>
                <py:for each="match in matches">
                    <!--! Full table -->
                    <tr class="visible-md visible-lg ${match['key']}">
                        <td>
                            <a href="/scout/match/${match['event_key']}/${match['key']}" title="Match Scout"><span class="fa fa-binoculars"></span></a>&nbsp;
                            <a href="/stats/${match['event_key']}/${match['key']}" title="Match Stats"><span class="fa fa-bar-chart"></span></a>&nbsp;
                            ${match_name(match)}
                            <py:if test="'videos' in match">
                                <py:for each="video in match['videos']">
                                    &nbsp;${video_icon(video, 'icon')}
                                </py:for>
                            </py:if>
                        </td>
                        <td py:if="[m for m in matches if 'time' in m and m['time']]">${datetime.fromtimestamp(match['time']).strftime('%I:%M %p') if match['time'] else ''}</td>
                        <py:for each="alliance in alliances">
                            <td class="${alliance} ${team}" py:attrs="{'style':'font-weight:bold;' if int(match['alliances'][alliance]['score']) &gt; max([int(match['alliances'][a]['score']) for a in match['alliances'] if a != alliance]) else ''}" py:for="team in match['alliances'][alliance]['teams']">
                                <py:with vars="team_number = re.sub(r'^[^0-9]+', '', team) or '0'; team_number_normalized = re.sub(r'[^0-9]', '', team_number)">
                                    <a href="/scout/match/${match['event_key']}/${match['key']}/${team}" title="Match Scout">${team_number}</a>
                                    <span class="fa fa-home" py:if="int(team_number_normalized) == int(session['team_number'] or -1)"></span>
                                    <span class="fa fa-asterisk" py:if="'team' in page and int(team_number_normalized) == int(page['team']['team_number'])"></span>
                                    <span class="fa fa-trophy" py:if="team in winners" title="Event Winner"></span>
                                    <span class="fa fa-check" style="display:${'' if 'scouting' in match and team in match['scouting'] else 'none'}"></span>
                                </py:with>
                            </td>
                            <td class="${alliance}" py:for="i in range(0, (alliances_teams[alliance]) - len(match['alliances'][alliance]['teams']))">&nbsp;</td>
                        </py:for>
                        <td class="${alliance}" py:attrs="{'style':'font-weight:bold;' if int(match['alliances'][alliance]['score']) &gt; max([int(match['alliances'][a]['score']) for a in match['alliances'] if a != alliance]) else ''}" py:for="alliance in alliances" py:if="max_score">${match['alliances'][alliance]['score'] if match['alliances'][alliance]['score'] > 0 else ''}</td>
                    </tr>
                    <!--! Collapsed table -->
                    <tr class="hidden-md hidden-lg ${match['key']} ${'border-bottom-dark' if alliance == alliances[::-1][0] else ''}" py:for="alliance in alliances">
                        <td py:if="alliance == alliances[0]">
                            <a href="/scout/match/${match['event_key']}/${match['key']}" title="Match Scout">
                                ${match_name(match)}
                            </a>
                        </td>
                        <td rowspan="${len(alliances)-1}" py:if="alliance == alliances[1] and [m for m in matches if 'time' in m and m['time']]">${datetime.fromtimestamp(match['time']).strftime('%I:%M %p') if match['time'] else ''}</td>
                        <td class="${alliance} ${team}" py:attrs="{'style':'font-weight:bold;' if int(match['alliances'][alliance]['score']) &gt; max([int(match['alliances'][a]['score']) for a in match['alliances'] if a != alliance]) else ''}" py:for="team in match['alliances'][alliance]['teams']">
                            <a href="/scout/match/${match['event_key']}/${match['key']}/${team}" title="Match Scout" py:with="team_number = re.sub(r'^[^0-9]+', '', team) or '0'; team_number_normalized = re.sub(r'[^0-9]', '', team_number)">
                                ${team_number}
                                <span class="fa fa-home" py:if="int(team_number_normalized) == int(session['team_number'] or -1)"></span>
                                <span class="fa fa-asterisk" py:if="'team' in page and int(team_number_normalized) == int(page['team']['team_number'])"></span>
                                <span class="fa fa-trophy" py:if="team in winners" title="Event Winner"></span>
                                <span class="fa fa-check" style="display:${'' if 'scouting' in match and team in match['scouting'] else 'none'}"></span>
                            </a>
                        </td>
                        <td class="${alliance}" py:attrs="{'style':'font-weight:bold;' if int(match['alliances'][alliance]['score']) &gt; max([int(match['alliances'][a]['score']) for a in match['alliances'] if a != alliance]) else ''}" py:if="max_score">${match['alliances'][alliance]['score'] if match['alliances'][alliance]['score'] > 0 else ''}</td>
                    </tr>
                </py:for>
            </tbody>
        </table>
    </py:def>


    <py:def function="stats_listing(stats)">
        <?python
            keys = []
            for team in stats:
                for key in team:
                    if not key.startswith('_') and key not in keys:
                        keys.append(key)
            keys = sorted(keys)
        ?>
        <table class="table table-bordered table-striped table-condensed">
            <thead>
                <tr>
                    <th py:for="key in keys">${re.sub(r'^[0-9]+_+', '', key).replace('_',' ').title()}</th>
                </tr>
            </thead>
            <tbody>
                <tr py:for="team in stats">
                    <td py:for="key in keys" py:choose="">
                        <ul py:when="type(team[key]) is list">
                            <li py:for="item in team[key]">${item}</li>
                        </ul>
                        <py:otherwise>${team[key]}</py:otherwise>
                    </td>
                </tr>
            </tbody>
        </table>
    </py:def>


    <py:def function="team_listing(teams, event={})">
        <table class="table table-bordered table-striped team-listing">
            <thead>
                <tr>
                    <th py:if="event">Pit Scout</th>
                    <th>Team Number</th>
                    <th>Team Name</th>
                    <th class="hidden-sm hidden-xs">Location</th>
                </tr>
            </thead>
            <tbody>
                <tr class="${team['key']}" py:for="team in teams">
                    <td py:if="event">
                        <a href="/scout/pit/${event['key']}/${team['key']}">Pit Scout</a>
                        <span class="fa fa-check" style="display:${'' if 'scouting' in team else 'none'}"></span>
                    </td>
                    <td>
                        <a href="/team/${team['key']}${'/'+str(event['year']) if event else ''}">${team['team_number']}</a>
                        <span class="fa fa-home" py:if="int(team['team_number']) == int(session['team_number'] or -1)"></span>
                    </td>
                    <td>
                        <a href="/team/${team['key']}${'/'+str(event['year']) if event else ''}" py:choose="">
                            <py:when test="len(team['nickname']) &gt; 100">${team['nickname'][:97]}...</py:when>
                            <py:when test="team['nickname']">${team['nickname']}</py:when>
                            <py:otherwise>--</py:otherwise>
                        </a>
                    </td>
                    <td class="hidden-sm hidden-xs">
                        <span class="${flag_icon_css(team['country_name'])}"></span>
                        <a href="https://www.google.com/maps/search/${team['location']}" target="_blank" py:choose="">
                            <py:when test="team['country_name'] == 'USA' or team['country_name'] == 'Canada'">${team['locality']}, ${team['region']}</py:when>
                            <py:otherwise>${team['locality']}, ${team['country_name']}</py:otherwise>
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </py:def>

    <py:def function="team_info(team)">
        <h2>
            <a href="/team/${team['key']}">Team ${team['team_number']} &mdash; ${team['nickname']}</a>
            <span class="fa fa-home" py:if="int(team['team_number']) == int(session['team_number'] or -1)"></span>
        </h2>
        <h4><em>${team['motto']}</em></h4>
        <h5><span class="fa fa-id-card-o"></span>&nbsp;&nbsp;${team['name']}</h5>
        <h5 py:if="team['website']"><span class="fa fa-globe"></span>&nbsp;&nbsp;<a href="${team['website']}" target="_blank">${team['website']}</a></h5>
        <h5><span class="fa fa-lightbulb-o fa-rotate-180"></span>&nbsp;&nbsp;<a href="hhttps://www.thebluealliance.com/team/${team['team_number']}" target="_blank">The Blue Alliance</a></h5>
        <h5 py:if="team['location']">
            <span class="fa fa-map-marker"></span>&nbsp;
            <span class="${flag_icon_css(team['country_name'])}"></span>
            <a href="https://www.google.com/maps/search/${team['location']}" target="_blank">${team['location']}</a>
        </h5>
        <h5 py:if="team['rookie_year']"><span class="fa fa-child"></span>&nbsp;&nbsp;Rookie Year: ${team['rookie_year']}</h5>
    </py:def>


    <py:def function="flag_icon_css(country_name)">
        <?python country_name = re.sub(r'.+,', '', country_name).strip() ?>
        flag-icon
        <py:choose test="country_name">
            <py:when test="'Australia'">flag-icon-au</py:when>
            <py:when test="'Bosnia-Herzegovina'">flag-icon-ba</py:when>
            <py:when test="'Brazil'">flag-icon-br</py:when>
            <py:when test="'Canada'">flag-icon-ca</py:when>
            <py:when test="'Chile'">flag-icon-cl</py:when>
            <py:when test="'China'">flag-icon-cn</py:when>
            <py:when test="'Colombia'">flag-icon-co</py:when>
            <py:when test="'Czech Republic'">flag-icon-cz</py:when>
            <py:when test="'Denmark'">flag-icon-dk</py:when>
            <py:when test="'Dominican Republic'">flag-icon-do</py:when>
            <py:when test="'Ecuador'">flag-icon-ec</py:when>
            <py:when test="'France'">flag-icon-fr</py:when>
            <py:when test="'Germany'">flag-icon-de</py:when>
            <py:when test="'India'">flag-icon-in</py:when>
            <py:when test="'Israel'">flag-icon-il</py:when>
            <py:when test="'Japan'">flag-icon-jp</py:when>
            <py:when test="'Kazakhstan'">flag-icon-kz</py:when>
            <py:when test="'Mexico'">flag-icon-mx</py:when>
            <py:when test="'Morocco'">flag-icon-ma</py:when>
            <py:when test="'Netherlands'">flag-icon-nl</py:when>
            <py:when test="'Pakistan'">flag-icon-pk</py:when>
            <py:when test="'Philippines'">flag-icon-ph</py:when>
            <py:when test="'Poland'">flag-icon-pl</py:when>
            <py:when test="'Singapore'">flag-icon-sg</py:when>
            <py:when test="'Spain'">flag-icon-es</py:when>
            <py:when test="'Switzerland'">flag-icon-ch</py:when>
            <py:when test="'Taiwan'">flag-icon-tw</py:when>
            <py:when test="'Turkey'">flag-icon-tr</py:when>
            <py:when test="'USA'">flag-icon-us</py:when>
            <py:when test="'United Arab Emirates'">flag-icon-ae</py:when>
            <py:when test="'United Kingdom'">flag-icon-gb</py:when>
            <py:when test="'United States'">flag-icon-us</py:when>
            <py:when test="'Vietnam'">flag-icon-vn</py:when>
        </py:choose>
    </py:def>


    <py:def function="video_icon(video, show='both', href='both')">
        <?python
            link = ''
            icon = 'fa fa-video-camera'
            title = ''

            if video['type'] == 'html5':
                link = video['channel']
            elif video['type'] == 'iframe':
                link = re.search(r'src="(.*?)"', video['channel'] or video['file']).group(1)
            elif video['type'] == 'livestream' and 'channel' in video and 'file' in video:
                link = 'https://livestream.com/accounts/' + video['channel'] + '/events/' + video['file']
            elif video['type'] == 'twitch':
                link = 'https://www.twitch.tv/' + video['channel']
                icon = 'fa fa-twitch'
                title = video['channel']
            elif video['type'] == 'ustream':
                link = 'http://www.ustream.tv/recorded/' + video['channel']
            elif video['type'] == 'youtube':
                link = 'https://www.youtube.com/watch?v=' + (video['channel'] if 'channel' in video else '') + (video['key'] if 'key' in video else '')
                icon = 'fa fa-youtube'

            if link[0:2] == '//':
                link = 'http:' + link

            if not title:
                title = link
            if not title:
                title = video['type'] + (' ' + video['channel'] if 'channel' in video else '') + (' ' + video['file'] if 'file' in video else '')
        ?>

        <a href="${link}" target="_blank" py:strip="not link or href != 'both'">
            <a href="${link}" target="_blank" py:if="link or show == 'both'" py:strip="not link or href != 'icon'">
                <py:if test="show in ['both','icon']"><span class="${icon}"></span><py:if test="show in ['both','title']">&nbsp;</py:if></py:if>
            </a>
            <a href="${link}" target="_blank" py:strip="not link or href != 'title'">
                <py:if test="show in ['both','title']">${title}</py:if>
            </a>
        </a>
    </py:def>
</html>